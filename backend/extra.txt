

/* =======================
   Simple voice agent no eleven labs
======================= */

import express from "express";
import twilio from "twilio";

import CallSession from "../models/CallSession.js";
import Customer from "../models/Customer.js";
import Complaint from "../models/Complaint.js";

const router = express.Router();
const VoiceResponse = twilio.twiml.VoiceResponse;

/* =======================
   FOR CLEAN PRONOUN SAVE
======================= */

function cleanSpeech(text) {
  if (!text) return "";

  return text
    .replace(/[à¥¤]/g, "") // remove Hindi full stop
    .replace(/[.,!?]/g, "") // remove English punctuation
    .trim()
    .toLowerCase();
}

/* =======================
   CONSTANTS
======================= */
const YES_WORDS = ["haan", "haanji", "yes", "ji", "bilkul", "sahi"];
const TRANSFER_KEYWORDS = ["agent", "human", "representative"];

const CONFUSION_WORDS = [
  "kya",
  "what",
  "repeat",
  "dobara",
  "samajh",
  "samajh nahi",
  "clear nahi",
  "pardon",
  "haan kya",
  "matlab",
];

/* =======================
   HELPER: ASK & LISTEN
======================= */
function ask(twiml, text, call) {
  if (call) {
    call.temp.lastQuestion = text;
  }

  const gather = twiml.gather({
    input: "speech",
    language: "hi-IN",
    speechTimeout: "auto",
    timeout: 6,
    action: "/voice/process",
    method: "POST",
  });

  // gather.say(text);

  gather.say(
    {
      voice: "Polly.Aditi",
      language: "hi-IN",
    },
    text,
  );
}

/* =======================
   INCOMING CALL
======================= */
router.post("/", async (req, res) => {
  const { CallSid, From } = req.body;
  const twiml = new VoiceResponse();

  await CallSession.findOneAndUpdate(
    { callSid: CallSid },
    {
      callSid: CallSid,
      from: From,
      step: "ask_chassis",
      temp: { retries: 0 },
    },
    { upsert: true, new: true },
  );

  const call = await CallSession.findOne({ callSid: CallSid });

  ask(
    twiml,
    "Namaskar. Main Rajesh Motors JCB se bol rahi hoon. Kripya apni machine ka chassis number boliye.",
    call,
  );

  res.type("text/xml").send(twiml.toString());
});

/* =======================
   PROCESS CALL
======================= */
router.post("/process", async (req, res) => {
  const twiml = new VoiceResponse();
  const { CallSid, SpeechResult } = req.body;
  const rawSpeech = SpeechResult || "";
  const speech = cleanSpeech(rawSpeech);
  // const speech = (SpeechResult || "").trim().toLowerCase();

  const call = await CallSession.findOne({ callSid: CallSid });

  if (!call || !speech) {
    ask(twiml, "Awaaz clear nahi aayi. Kripya dobara boliye.", call);
    return res.type("text/xml").send(twiml.toString());
  }

  /* ðŸ” Transfer to Human */
  if (TRANSFER_KEYWORDS.some((w) => speech.includes(w))) {
    twiml.say(
      "Theek hai. Aapko customer care agent se connect kiya ja raha hai.",
    );
    twiml.dial(process.env.HUMAN_AGENT_NUMBER);
    return res.type("text/xml").send(twiml.toString());
  }

  /* ðŸ¤” Confusion Handling */
  if (
    CONFUSION_WORDS.some((w) => speech.includes(w)) &&
    call.temp?.lastQuestion
  ) {
    call.temp.retries += 1;

    if (call.temp.retries > 3) {
      twiml.say("Main aapko agent se connect kar raha hoon.");
      twiml.dial(process.env.HUMAN_AGENT_NUMBER);
      return res.type("text/xml").send(twiml.toString());
    }

    ask(twiml, call.temp.lastQuestion, call);
    await call.save();
    return res.type("text/xml").send(twiml.toString());
  }

  call.temp.retries = 0;

  /* =======================
     STATE MACHINE
  ======================= */
  switch (call.step) {
    /* ---------- ASK CHASSIS ---------- */
    case "ask_chassis": {
      if (speech.length < 4) {
        ask(
          twiml,
          "Chassis number clear nahi mila. Kripya dheere aur saaf boliye.",
          call,
        );
        break;
      }

      call.temp.chassisNo = speech;
      const customer = await Customer.findOne({ chassisNo: speech });

      if (customer) {
        call.temp.customerId = customer._id;
        call.temp.name = customer.name;
        call.temp.phone = customer.phone;
        call.temp.city = customer.city;
        call.step = "ask_complaint";

        ask(
          twiml,
          `Dhanyavaad. Record mil gaya hai. Aap ${customer.name} ${customer.city} se bol rahe hain.
           Ab kripya apni problem batayein.`,
          call,
        );
      } else {
        call.step = "repeat_chassis";
        ask(
          twiml,
          "Record nahi mila. Kripya chassis number dobara boliye.",
          call,
        );
      }

      break;
    }

    /* ---------- REPEAT CHASSIS ---------- */
    case "repeat_chassis": {
      if (speech.length < 4) {
        ask(
          twiml,
          "Chassis number clear nahi mila. Kripya dobara boliye.",
          call,
        );
        break;
      }

      call.temp.chassisNo = speech;
      const customer = await Customer.findOne({ chassisNo: speech });

      if (customer) {
        call.temp.customerId = customer._id;
        call.temp.name = customer.name;
        call.temp.phone = customer.phone;
        call.temp.city = customer.city;
        call.step = "ask_complaint";

        ask(twiml, "Record mil gaya hai. Kripya apni problem batayein.", call);
      } else {
        call.step = "ask_name";
        ask(twiml, "Record nahi mila. Kripya apna poora naam boliye.", call);
      }
      break;
    }

    /* ---------- ASK NAME ---------- */
    case "ask_name":
      call.temp.name = speech;
      call.step = "ask_phone";
      ask(
        twiml,
        "Dhanyavaad. Ab kripya apna 10 digit mobile number boliye.",
        call,
      );
      break;

    /* ---------- ASK PHONE ---------- */
    case "ask_phone": {
      call.temp.phone = speech.replace(/\D/g, "");

      if (call.temp.phone.length !== 10) {
        ask(
          twiml,
          "Mobile number sahi nahi lag raha. Kripya sirf 10 digit number boliye.",
          call,
        );
        break;
      }

      const customer = await Customer.findOne({ phone: call.temp.phone });

      if (customer) {
        call.temp.customerId = customer._id;
        call.temp.city = customer.city;
        call.step = "confirm_customer";

        ask(
          twiml,
          `Aap ${customer.name} se bol rahe hain. Kya ye sahi hai? yes ya no boliye.`,
          call,
        );
      } else {
        call.step = "ask_city";
        ask(twiml, "Kripya apne sheher ka naam boliye.", call);
      }
      break;
    }

    /* ---------- CONFIRM CUSTOMER ---------- */
    case "confirm_customer":
      if (YES_WORDS.some((w) => speech.includes(w))) {
        call.step = "ask_complaint";
        ask(twiml, "Ab kripya apni machine ki problem batayein.", call);
      } else {
        call.step = "ask_city";
        ask(twiml, "Theek hai. Kripya apne sheher ka naam boliye.", call);
      }
      break;

    /* ---------- ASK CITY ---------- */
    case "ask_city":
      call.temp.city = speech;
      call.step = "ask_complaint";
      ask(twiml, "Dhanyavaad. Ab kripya apni problem batayein.", call);
      break;

    /* ---------- COMPLAINT ---------- */
    case "ask_complaint": {
      call.temp.complaint = speech;
      call.step = "done";

      const customer = call.temp.customerId
        ? await Customer.findById(call.temp.customerId)
        : await Customer.create({
            chassisNo: call.temp.chassisNo,
            name: call.temp.name,
            phone: call.temp.phone,
            city: call.temp.city,
          });

      await Complaint.create({
        customerId: customer._id,
        chassisNo: call.temp.chassisNo,
        phone: call.temp.phone,
        description: call.temp.complaint,
        callSid: CallSid,
        status: "open",
      });

      twiml.say(
        "Dhanyavaad. Aapki complaint register ho chuki hai. Hamari service team jald hi aapse sampark karegi.",
      );
      twiml.hangup();
      break;
    }
  }

  await call.save();
  res.type("text/xml").send(twiml.toString());
});

export default router;



















/* =======================
   Even Labs added for clear voice
======================= */

import express from "express";
import twilio from "twilio";

import CallSession from "../models/CallSession.js";
import Customer from "../models/Customer.js";
import Complaint from "../models/Complaint.js";

import { generateSpeech } from "../services/elevenlabsTTS.js";

const router = express.Router();
const VoiceResponse = twilio.twiml.VoiceResponse;

/* =======================
   CLEAN SPEECH
======================= */
function cleanSpeech(text) {
  if (!text) return "";
  return text
    .replace(/[à¥¤]/g, "")
    .replace(/[.,!?]/g, "")
    .trim()
    .toLowerCase();
}

/* =======================
   CONSTANTS
======================= */
const YES_WORDS = ["haan", "haanji", "yes", "ji", "bilkul", "sahi"];
const TRANSFER_KEYWORDS = ["agent", "human", "representative"];

const CONFUSION_WORDS = [
  "kya",
  "what",
  "repeat",
  "dobara",
  "samajh",
  "samajh nahi",
  "clear nahi",
  "pardon",
  "haan kya",
  "matlab",
];

const TRANSFER_WORDS = [
  "transfer",
  "call transfer",
  "agent",
  "human",
  "representative",
  "baat karni",
  "human se",
  "agent se",
];

/* =======================
   ASK + LISTEN (ElevenLabs)
======================= */
async function ask(twiml, text, call) {
  if (call) call.temp.lastQuestion = text;

  const gather = twiml.gather({
    input: "speech",
    language: "hi-IN",
    speechTimeout: "auto",
    timeout: 6,
    action: "/voice/process",
    method: "POST",
  });

  try {
    const audioUrl = await generateSpeech(text, `tts_${Date.now()}.mp3`);
    gather.play(audioUrl);
  } catch (err) {
    console.error("ElevenLabs failed, fallback to Polly:", err.message);
    gather.say({ voice: "Polly.Aditi", language: "hi-IN" }, text);
  }
}

/* =======================
   INCOMING CALL
======================= */
router.post("/", async (req, res) => {
  const { CallSid, From } = req.body;
  const twiml = new VoiceResponse();

  await CallSession.findOneAndUpdate(
    { callSid: CallSid },
    {
      callSid: CallSid,
      from: From,
      step: "ask_chassis",
      temp: { retries: 0 },
    },
    { upsert: true, new: true },
  );

  const call = await CallSession.findOne({ callSid: CallSid });

  await ask(
    twiml,
    "Namaskar. Main Rajesh Motors JCB se bol raha hoon. Kripya apni machine ka chassis number boliye.",
    call,
  );

  res.type("text/xml").send(twiml.toString());
});

/* =======================
   PROCESS CALL
======================= */
router.post("/process", async (req, res) => {
  const twiml = new VoiceResponse();
  const { CallSid, SpeechResult } = req.body;
  const speech = cleanSpeech(SpeechResult || "");

  const call = await CallSession.findOne({ callSid: CallSid });

  if (!call || !speech) {
    await ask(twiml, "Awaaz clear nahi aayi. Kripya dobara boliye.", call);
    return res.type("text/xml").send(twiml.toString());
  }

  /* ðŸ” Transfer to Human */
  if (TRANSFER_KEYWORDS.some((w) => speech.includes(w))) {
    // twiml.say(
    //   "Theek hai. Aapko customer care agent se connect kiya ja raha hai.",
    // );
    // twiml.dial(process.env.HUMAN_AGENT_NUMBER);
    await ask(
      twiml,
      "Theek hai. Aapko customer care agent se connect kiya ja raha hai.",
      call,
    );
    twiml.dial(process.env.HUMAN_AGENT_NUMBER);
    return res.type("text/xml").send(twiml.toString());
  }

  /* ðŸ¤” Confusion Handling */
  if (
    CONFUSION_WORDS.some((w) => speech.includes(w)) &&
    call.temp?.lastQuestion
  ) {
    call.temp.retries += 1;

    if (call.temp.retries > 3) {
      twiml.say("Main aapko agent se connect kar raha hoon.");
      twiml.dial(process.env.HUMAN_AGENT_NUMBER);
      return res.type("text/xml").send(twiml.toString());
    }

    await ask(twiml, call.temp.lastQuestion, call);
    await call.save();
    return res.type("text/xml").send(twiml.toString());
  }

  call.temp.retries = 0;

  /* =======================
     STATE MACHINE
  ======================= */
  switch (call.step) {
    case "ask_chassis": {
      if (speech.length < 4) {
        await ask(
          twiml,
          "Chassis number clear nahi mila. Kripya dheere boliye.",
          call,
        );
        break;
      }

      call.temp.chassisNo = speech;
      const customer = await Customer.findOne({ chassisNo: speech });

      if (customer) {
        call.temp.customerId = customer._id;
        call.temp.name = customer.name;
        call.temp.phone = customer.phone;
        call.temp.city = customer.city;
        call.step = "ask_complaint";

        await ask(
          twiml,
          `Dhanyavaad. Aap ${customer.name}, ${customer.city} se bol rahe hain. Ab apni problem batayein.`,
          call,
        );
      } else {
        call.step = "unregistered_options";
        await ask(
          twiml,
          "Aap pehle se registered nahi lag rahe hain. Ya toh sahi chassis number boliye, ya kya main aapki call human agent ko transfer kar doon?",
          call,
        );
      }
      break;
    }

    case "unregistered_options": {
      // If user wants human
      if (TRANSFER_WORDS.some((w) => speech.includes(w))) {
        await ask(
          twiml,
          "Theek hai. Main aapko customer care agent se connect kar raha hoon.",
          call,
        );
        twiml.dial(process.env.HUMAN_AGENT_NUMBER);
        return res.type("text/xml").send(twiml.toString());
      }

      // If user tries chassis again
      if (speech.length >= 4) {
        call.temp.chassisNo = speech;
        const customer = await Customer.findOne({ chassisNo: speech });

        if (customer) {
          call.temp.customerId = customer._id;
          call.temp.name = customer.name;
          call.temp.phone = customer.phone;
          call.temp.city = customer.city;
          call.step = "ask_complaint";

          await ask(
            twiml,
            `Dhanyavaad. Aap ${customer.name}, ${customer.city} se bol rahe hain. Ab apni problem batayein.`,
            call,
          );
        } else {
          call.step = "ask_name";
          await ask(
            twiml,
            "Chassis number phir bhi nahi mila. Kripya apna poora naam boliye.",
            call,
          );
        }
        break;
      }

      // If unclear response
      await ask(
        twiml,
        "Kripya sahi chassis number boliye ya human agent ke liye boliye.",
        call,
      );
      break;
    }

    case "repeat_chassis": {
      call.temp.chassisNo = speech;
      call.step = "ask_name";
      await ask(twiml, "Kripya apna poora naam boliye.", call);
      break;
    }

    case "ask_name":
      call.temp.name = speech;
      call.step = "ask_phone";
      await ask(twiml, "Ab apna 10 digit mobile number boliye.", call);
      break;

    case "ask_phone": {
      call.temp.phone = speech.replace(/\D/g, "");
      if (call.temp.phone.length !== 10) {
        await ask(
          twiml,
          "Mobile number galat lag raha hai. Dobara boliye.",
          call,
        );
        break;
      }

      call.step = "ask_city";
      await ask(twiml, "Kripya apne sheher ka naam boliye.", call);
      break;
    }

    case "ask_city":
      call.temp.city = speech;
      call.step = "ask_complaint";
      await ask(twiml, "Ab kripya apni machine ki problem batayein.", call);
      break;

    case "ask_complaint": {
      call.temp.complaint = speech;
      call.step = "done";

      // const customer = await Customer.create({
      //   chassisNo: call.temp.chassisNo,
      //   name: call.temp.name,
      //   phone: call.temp.phone,
      //   city: call.temp.city,
      // });

      const customer = await Customer.findOneAndUpdate(
        { chassisNo: call.temp.chassisNo },
        {
          $set: {
            name: call.temp.name,
            phone: call.temp.phone,
            city: call.temp.city,
          },
        },
        { upsert: true, new: true },
      );

      await Complaint.create({
        customerId: customer._id,
        chassisNo: call.temp.chassisNo,
        phone: call.temp.phone,
        description: call.temp.complaint,
        callSid: CallSid,
        status: "open",
      });

      await ask(
        twiml,
        "Dhanyavaad. Aapki complaint register ho chuki hai. Hamari team jald sampark karegi.",
        call,
      );
      twiml.hangup();
      break;
    }
  }

  await call.save();
  res.type("text/xml").send(twiml.toString());
});

export default router;

/* =======================
 Db configure properly voice call agent
======================= */

import express from "express";
import twilio from "twilio";

import CallSession from "../models/CallSession.js";
import Customer from "../models/Customer.js";
import Complaint from "../models/Complaint.js";

const router = express.Router();
const VoiceResponse = twilio.twiml.VoiceResponse;

/* =======================
   CLEAN SPEECH
======================= */
function cleanSpeech(text) {
  if (!text) return "";
  return text.replace(/[à¥¤.,!?]/g, "").trim().toLowerCase();
}

/* =======================
   CONSTANTS
======================= */
const TRANSFER_KEYWORDS = ["agent", "human", "representative"];
const CONFUSION_WORDS = [
  "kya",
  "repeat",
  "dobara",
  "samajh",
  "samajh nahi",
  "clear nahi",
  "pardon",
];

/* =======================
   ASK + LISTEN
======================= */
function ask(twiml, text, call) {
  call.temp.lastQuestion = text;

  const gather = twiml.gather({
    input: "speech",
    language: "hi-IN",
    speechTimeout: "auto",
    timeout: 6,
    action: "/voice/process",
    method: "POST",
  });

  gather.say({ voice: "Polly.Aditi", language: "hi-IN" }, text);
}

/* =======================
   INCOMING CALL
======================= */
router.post("/", async (req, res) => {
  const { CallSid, From } = req.body;
  const twiml = new VoiceResponse();

  await CallSession.findOneAndUpdate(
    { callSid: CallSid },
    {
      callSid: CallSid,
      from: From,
      step: "ask_identifier",
      temp: { retries: 0 },
    },
    { upsert: true, new: true }
  );

  const call = await CallSession.findOne({ callSid: CallSid });

  ask(
    twiml,
    "Namaskar. Kripya apni machine ka chassis number ya apna registered mobile number boliye.",
    call
  );

  res.type("text/xml").send(twiml.toString());
});

/* =======================
   PROCESS CALL
======================= */
router.post("/process", async (req, res) => {
  const twiml = new VoiceResponse();
  const { CallSid, SpeechResult } = req.body;

  const speech = cleanSpeech(SpeechResult || "");
  const call = await CallSession.findOne({ callSid: CallSid });

  if (!call || !speech) {
    ask(twiml, "Awaaz clear nahi aayi. Kripya dobara boliye.", call);
    return res.type("text/xml").send(twiml.toString());
  }

  /* ðŸ” MANUAL TRANSFER */
  if (TRANSFER_KEYWORDS.some((w) => speech.includes(w))) {
    twiml.say("Aapko agent se connect kiya ja raha hai.");
    twiml.dial(process.env.HUMAN_AGENT_NUMBER);
    return res.type("text/xml").send(twiml.toString());
  }

  /* ðŸ¤” CONFUSION HANDLING */
  if (CONFUSION_WORDS.some((w) => speech.includes(w))) {
    call.temp.retries += 1;

    if (call.temp.retries > 2) {
      twiml.say("Aapko agent se connect kiya ja raha hai.");
      twiml.dial(process.env.HUMAN_AGENT_NUMBER);
      return res.type("text/xml").send(twiml.toString());
    }

    ask(twiml, call.temp.lastQuestion, call);
    await call.save();
    return res.type("text/xml").send(twiml.toString());
  }

  call.temp.retries = 0;

  /* =======================
     STATE MACHINE
  ======================= */
  switch (call.step) {
    /* ---------- IDENTIFIER ---------- */
    case "ask_identifier": {
      const digits = speech.replace(/\D/g, "");
      let customer = null;

      if (digits.length === 10) {
        customer = await Customer.findOne({ phone: digits });
      }

      if (!customer) {
        customer = await Customer.findOne({ chassisNo: speech });
      }

      if (!customer) {
        call.temp.retries += 1;

        if (call.temp.retries > 2) {
          twiml.say("Record nahi mila. Aapko agent se connect kiya ja raha hai.");
          twiml.dial(process.env.HUMAN_AGENT_NUMBER);
          return res.type("text/xml").send(twiml.toString());
        }

        ask(
          twiml,
          "Record nahi mila. Kripya chassis number ya registered mobile number dobara boliye.",
          call
        );
        break;
      }

      call.temp.customerId = customer._id;
      call.step = "ask_complaint";

      ask(
        twiml,
        `Aapka record mil gaya hai. Aap ${customer.city} se ${customer.name} baat kar rahe hain. Kripya apni problem batayein.`,
        call
      );
      break;
    }

    /* ---------- COMPLAINT ---------- */
    case "ask_complaint": {
      const customer = await Customer.findById(call.temp.customerId);

      await Complaint.create({
        customerId: customer._id,
        chassisNo: customer.chassisNo,
        phone: customer.phone,
        name: customer.name,
        city: customer.city,
        machineModel: customer.machineModel,
        warrantyStatus: customer.warrantyStatus,
        description: speech,
        callSid: CallSid,
      });

      twiml.say(
        "Dhanyavaad. Aapki complaint register ho chuki hai. Hamari service team jald hi aapse sampark karegi."
      );
      twiml.hangup();
      break;
    }
  }

  await call.save();
  res.type("text/xml").send(twiml.toString());
});

export default router;













/* ==========================
======= data perfect ly saved
============================== */

// import express from "express";
// import twilio from "twilio";

// import CallSession from "../models/CallSession.js";
// import Customer from "../models/Customer.js";
// import Complaint from "../models/Complaint.js";
// import complaintMap from "../utils/complaintClassifier.js";

// const router = express.Router();
// const VoiceResponse = twilio.twiml.VoiceResponse;

// /* =======================
//    CLEAN SPEECH
// ======================= */
// function cleanSpeech(text) {
//   if (!text) return "";
//   return text
//     .toLowerCase()
//     .replace(/[à¥¤.,!?]/g, "")
//     .replace(/\s+/g, " ")
//     .trim();
// }

// function normalizeText(text) {
//   if (!text) return "";
//   return text.toLowerCase().replace(/\s+/g, " ").trim();
// }

// /* =======================
//    HINDI â†’ ENGLISH NORMALISER
//    Twilio hi-IN STT returns Devanagari script.
//    Every keyword used in detectComplaintIntent() AND in followUpQuestions options
//    MUST have its Devanagari form mapped here â€” otherwise includes() will never
//    match and the caller silently gets "Other".
//    Keys are sorted longest-first at runtime so multi-word phrases match before
//    their own substrings (e.g. "à¤•à¤¾à¤® à¤¨à¤¹à¥€à¤‚ à¤•à¤° à¤°à¤¹à¥€" before "à¤•à¤¾à¤® à¤¨à¤¹à¥€à¤‚").
// ======================= */
// const hindiToEnglishMap = {
//   // â”€â”€â”€ top-level complaint categories â”€â”€â”€
//   "à¤Ÿà¤¾à¤¯à¤°": "tyre",
//   "à¤Ÿà¤¾à¤¯à¤° à¤¨à¤¹à¥€à¤‚": "tyre",
//   "à¤à¤¸à¥€": "ac",
//   "à¤.à¤¸à¥€": "ac",
//   "à¤‡à¤‚à¤œà¤¨": "engine",
//   "à¤¹à¤¾à¤‡à¤¡à¥à¤°à¥‹à¤²à¤¿à¤•": "hydraulic",
//   "à¤¬à¤¿à¤œà¤²à¥€": "electrical",
//   "à¤‡à¤²à¥‡à¤•à¥à¤Ÿà¥à¤°à¤¿à¤•à¤²": "electrical",
//   "à¤¬à¥ˆà¤Ÿà¤°à¥€": "battery",

//   // â”€â”€â”€ generic intent words â”€â”€â”€
//   "à¤¨à¥‰à¤Ÿ à¤µà¤°à¥à¤•à¤¿à¤‚à¤—": "not working",
//   "à¤µà¤°à¥à¤• à¤¨à¤¹à¥€à¤‚": "not working",
//   "à¤•à¤¾à¤® à¤¨à¤¹à¥€à¤‚ à¤•à¤° à¤°à¤¹à¤¾ à¤¹à¥ˆ": "not working",
//   "à¤•à¤¾à¤® à¤¨à¤¹à¥€à¤‚ à¤•à¤° à¤°à¤¹à¥€ à¤¹à¥ˆ": "not working",
//   "à¤•à¤¾à¤® à¤¨à¤¹à¥€à¤‚ à¤•à¤° à¤°à¤¹à¤¾": "not working",
//   "à¤•à¤¾à¤® à¤¨à¤¹à¥€à¤‚ à¤•à¤° à¤°à¤¹à¥€": "not working",
//   "à¤•à¤¾à¤® à¤¨à¤¹à¥€à¤‚": "not working",
//   "à¤ à¤‚à¤¡à¤¾ à¤¨à¤¹à¥€à¤‚": "cooling",
//   "à¤ à¤‚à¤¡à¥€ à¤¨à¤¹à¥€à¤‚": "cooling",
//   "à¤ à¤‚à¤¡à¤¾": "cooling",
//   "à¤ à¤‚à¤¡à¥€": "cooling",

//   // â”€â”€â”€ AC sub-complaint keywords â”€â”€â”€
//   "à¤•à¥‚à¤²à¤¿à¤‚à¤—": "cooling",
//   "à¤¬à¤‚à¤¦": "band",

//   // â”€â”€â”€ Engine sub-complaint keywords â”€â”€â”€
//   "à¤¸à¥à¤®à¥‹à¤•": "smoke",
//   "à¤§à¥à¤†": "dhua",
//   "à¤§à¥à¤¯à¥‚à¤†": "dhua",
//   "à¤¨à¤¾à¤‡à¤¸": "noise",
//   "à¤¨à¥‰à¤‡à¤œà¤¼": "noise",
//   "à¤¨à¥‰à¤‡à¤œ": "noise",
//   "à¤†à¤µà¤¾à¤œà¤¼": "awaz",
//   "à¤†à¤µà¤¾à¤œ": "awaz",
//   "à¤—à¤°à¤®": "garam",
//   "à¤“à¤µà¤°à¤¹à¥€à¤Ÿ": "overheat",
//   "à¤¸à¥à¤Ÿà¤¾à¤°à¥à¤Ÿ à¤¨à¤¹à¥€à¤‚": "start",
//   "à¤¸à¥à¤Ÿà¤¾à¤°à¥à¤Ÿ": "start",
//   "à¤®à¤¿à¤¸à¤¿à¤‚à¤—": "missing",
//   "à¤¹à¥€à¤Ÿ": "heat",

//   // â”€â”€â”€ Hydraulic sub-complaint keywords â”€â”€â”€
//   "à¤ªà¥à¤°à¥‡à¤¶à¤°": "pressure",
//   "à¤²à¥€à¤•": "leak",
//   "à¤²à¥€à¤•à¥‡à¤œ": "leak",
//   "à¤¸à¥à¤²à¥‹": "slow",
//   "à¤§à¥€à¤°à¥‡": "dheere",
//   "à¤•à¤®": "kam",

//   // â”€â”€â”€ Electrical sub-complaint keywords â”€â”€â”€
//   "à¤¸à¥à¤Ÿà¤¾à¤°à¥à¤Ÿà¤°": "starter",
//   "à¤¸à¥‡à¤²à¥à¤«": "self",
//   "à¤µà¤¾à¤¯à¤°à¤¿à¤‚à¤—": "wiring",
//   "à¤²à¤¾à¤‡à¤Ÿ": "light",
//   "à¤†à¤°à¤ªà¥€à¤à¤®": "rpm",
//   "à¤®à¥€à¤Ÿà¤°": "meter",

//   // â”€â”€â”€ Tyre sub-complaint keywords â”€â”€â”€
//   "à¤ªà¤‚à¤•à¥à¤šà¤°": "puncture",
//   "à¤«à¤Ÿà¤¾ à¤—à¤¯à¤¾": "phatta",
//   "à¤«à¤Ÿà¥‡ à¤—à¤": "phatta",
//   "à¤«à¤Ÿ à¤—à¤¯à¤¾": "phatta",
//   "à¤«à¤Ÿà¤¾": "phatta",
//   "à¤«à¤Ÿà¥‡": "phatta",
//   "à¤«à¤Ÿ": "phatta",
//   "à¤•à¤Ÿ à¤—à¤¯à¤¾": "cut",
//   "à¤•à¤Ÿ": "cut",
//   "à¤¡à¥‡à¤¡": "dead",

//   // â”€â”€â”€ Transmission sub-complaint keywords â”€â”€â”€
//   "à¤—à¤¿à¤¯à¤°": "gear",
//   "à¤—à¤¿à¤¯à¤¼à¤¾à¤°": "gear",
//   "à¤¬à¥à¤°à¥‡à¤•": "brake",
//   "à¤°à¤¿à¤µà¤°à¥à¤¸": "reverse",

//   // â”€â”€â”€ Ram/Cylinder sub-complaint keywords â”€â”€â”€
//   "à¤°à¥‰à¤¡": "rod",
//   "à¤°à¥ˆà¤®": "ram",
//   "à¤¸à¥€à¤²": "seal",
//   "à¤¬à¥‡à¤‚à¤¡": "bend",
//   "à¤Ÿà¥‚à¤Ÿà¤¾ à¤—à¤¯à¤¾": "toot",
//   "à¤Ÿà¥‚à¤Ÿà¤¾": "toot",
//   "à¤Ÿà¥‚à¤Ÿà¥‡": "toot",

//   // â”€â”€â”€ Hose sub-complaint keywords â”€â”€â”€
//   "à¤¹à¥‹à¤¸": "hose",
//   "à¤ªà¤¾à¤‡à¤ª": "pipe",
//   "à¤“ à¤°à¤¿à¤‚à¤—": "o ring",

//   // â”€â”€â”€ Under Carriage sub-complaint keywords â”€â”€â”€
//   "à¤Ÿà¥à¤°à¥ˆà¤•": "track",
//   "à¤°à¥‹à¤²à¤°": "roller",
//   "à¤†à¤‡à¤¡à¤²à¤°": "idler",
//   "à¤†à¤‡à¤¡à¤²à¥‡à¤°": "idler",
//   "à¤¸à¥à¤ªà¥à¤°à¥‰à¤•à¥‡à¤Ÿ": "sprocket",
// };

// // pre-sort keys longest-first so multi-word phrases match before substrings
// const sortedHindiKeys = Object.keys(hindiToEnglishMap).sort(
//   (a, b) => b.length - a.length
// );

// function normalizeHindiIntent(text) {
//   if (!text) return "";
//   let normalized = text;
//   for (const hindi of sortedHindiKeys) {
//     if (normalized.includes(hindi)) {
//       normalized += " " + hindiToEnglishMap[hindi];
//     }
//   }
//   return normalized;
// }

// /* =======================
//    FOLLOW UP QUESTIONS
//    Contextual sub-complaint prompts asked AFTER a complaint category is detected.
//    â€¢ question  â†’ what the IVR says
//    â€¢ options   â†’ keyword â†’ sub-complaint title (partial match via includes())
// ======================= */
// const followUpQuestions = {
//   "AC System": {
//     question:
//       "AC cooling nahi kar rahi hai ya bilkul kaam nahi kar rahi hai? Cooling hai ya band hai?",
//     options: {
//       cooling: "AC not Cooling",
//       thanda: "AC not Cooling",
//       "nahi kar rahi": "AC not Cooling",
//       band: "AC not Working",
//       "not working": "AC not Working",
//       kaam: "AC not Working",
//     },
//   },

//   Engine: {
//     question:
//       "Engine mein kya dikkat hai? Overheating hai, smoke aa raha hai, noise hai ya start mein problem hai?",
//     options: {
//       overheat: "Engine Over heating",
//       garam: "Engine Over heating",
//       heat: "Engine Over heating",
//       smoke: "Smoke problem",
//       dhua: "Smoke problem",
//       noise: "Abnormal Noise",
//       awaz: "Abnormal Noise",
//       start: "Missing problem",
//       missing: "Missing problem",
//     },
//   },

//   Hydraulic: {
//     question:
//       "Hydraulic mein kya problem hai? Pressure kam hai, leak hai ya machine slow chal rahi hai?",
//     options: {
//       pressure: "Pressure down",
//       kam: "Pressure down",
//       leak: "Hydraulic pump leak",
//       slow: "Machine performance low/Slow working",
//       dheere: "Machine performance low/Slow working",
//     },
//   },

//   "Electrical Complaint": {
//     question:
//       "Electrical mein kya dikkat hai? Battery hai, self starter hai, wiring hai ya light mein problem hai?",
//     options: {
//       battery: "Battery problem",
//       starter: "Self/Starter motor problem",
//       self: "Self/Starter motor problem",
//       wiring: "Wiring problem",
//       light: "Light not working",
//       rpm: "speed/rpm meter not working",
//       meter: "speed/rpm meter not working",
//     },
//   },

//   "Tyre/Battery": {
//     question:
//       "Tyre mein kya problem hai? Phatta gaya hai, puncture hai ya cut hai?",
//     options: {
//       puncture: "Tyre puncture",
//       phatta: "Tyre puncture",
//       burst: "Tyre puncture",
//       cut: "Tyre cut",
//       battery: "Battery problem",
//       dead: "Battery problem",
//     },
//   },

//   "Transmission/Axle components": {
//     question:
//       "Transmission mein kya problem hai? Gear hai, brake hai ya reverse mein dikkat hai?",
//     options: {
//       gear: "Gear box problem",
//       gearbox: "Gear box problem",
//       brake: "Brake problem",
//       reverse: "Reverse forward issue",
//     },
//   },

//   "Ram/Cylinder": {
//     question:
//       "Ram ya cylinder mein kya problem hai? Leak hai, rod bend hai ya rod toot gaya hai?",
//     options: {
//       leak: "Ram leak",
//       bend: "Rod bend",
//       toot: "Rod broken",
//       broken: "Rod broken",
//       seal: "Seal leak",
//     },
//   },

//   Hose: {
//     question:
//       "Hose mein kya problem hai? Cut hai, leak hai ya O-ring mein dikkat hai?",
//     options: {
//       cut: "Hose cut",
//       leak: "Hose leakages",
//       "o ring": "Hose O ring Cut",
//       oring: "Hose O ring Cut",
//     },
//   },

//   "Under Carriage": {
//     question:
//       "Under carriage mein kya problem hai? Track hai, roller hai ya idler mein dikkat hai?",
//     options: {
//       track: "Track Motor leak",
//       roller: "Roller leakage",
//       idler: "Idler wheel noise",
//     },
//   },
// };

// /* =======================
//     HINDI NUMBER MAP
// ======================= */
// const hindiNumberMap = {
//   shunya: "0",
//   zero: "0",
//   ek: "1",
//   do: "2",
//   teen: "3",
//   char: "4",
//   chaar: "4",
//   paanch: "5",
//   panch: "5",
//   chhe: "6",
//   che: "6",
//   saat: "7",
//   aath: "8",
//   nau: "9",
// };

// function wordsToDigits(text) {
//   if (!text) return "";
//   let result = "";
//   text.split(" ").forEach((word) => {
//     if (hindiNumberMap[word]) {
//       result += hindiNumberMap[word];
//     }
//   });
//   return result;
// }

// /* =======================
//     CONFUSION DETECTION
// ======================= */
// function isConfusedSpeech(text) {
//   if (!text) return false;
//   const confusionWords = [
//     "kya",
//     "repeat",
//     "dobara",
//     "samajh nahi aaya",
//     "samajh nahi",
//     "fir se",
//   ];
//   return confusionWords.some((word) => text.includes(word));
// }

// /* =======================
//   COMPLAINT INTENT DETECTOR
//   Returns { primary, secondary[], confidence } or null.
//     confidence 0.95 â†’ single unambiguous match  â†’ skip confirmation
//     confidence 0.60 â†’ multiple possible matches â†’ ask confirmation first
// ======================= */
// function detectComplaintIntent(text) {
//   if (!text) return null;

//   const matches = [];
//   const words = text.split(" ");

//   // keywords too short / too common to be valid category-level signals
//   const SKIP_KEYWORDS = ["ek", "not working", "band"];

//   for (const [title, data] of Object.entries(complaintMap)) {
//     for (const keyword of data.keywords) {
//       if (SKIP_KEYWORDS.includes(keyword)) continue;

//       if (
//         text.includes(keyword) ||
//         words.some(
//           (w) =>
//             w.length > 2 &&
//             (keyword.includes(w) || w.includes(keyword))
//         )
//       ) {
//         matches.push(title);
//         break; // one match per category is enough
//       }
//     }
//   }

//   if (matches.length === 0) return null;

//   return {
//     primary: matches[0],
//     secondary: matches.slice(1),
//     confidence: matches.length === 1 ? 0.95 : 0.6,
//   };
// }

// /* =======================
//    ASK WITH GATHER  (enforces single gather per TwiML response)
// ======================= */
// function ask(twiml, text, call) {
//   call.temp.lastQuestion = text;

//   const gather = twiml.gather({
//     input: "speech",
//     language: "hi-IN",
//     speechTimeout: "auto",
//     timeout: 6,
//     actionOnEmptyResult: true,
//     action: "/voice/process",
//     method: "POST",
//   });

//   gather.say({ voice: "Polly.Aditi", language: "hi-IN" }, text);
// }

// /* =======================
//    INCOMING CALL  â€”  POST /voice/
// ======================= */
// router.post("/", async (req, res) => {
//   const { CallSid, From } = req.body;
//   const twiml = new VoiceResponse();

//   await CallSession.findOneAndUpdate(
//     { callSid: CallSid },
//     {
//       callSid: CallSid,
//       from: From,
//       step: "ivr_menu",
//       temp: { retries: 0 },
//     },
//     { upsert: true, new: true }
//   );

//   const gather = twiml.gather({
//     input: "dtmf",
//     numDigits: 1,
//     timeout: 5,
//     action: "/voice/process",
//     method: "POST",
//   });

//   gather.say(
//     { voice: "Polly.Aditi", language: "hi-IN" },
//     "Complaint register karne ke liye ek dabayein. Human agent se baat karne ke liye do dabayein."
//   );

//   res.type("text/xml").send(twiml.toString());
// });

// /* =======================
//    PROCESS CALL  â€”  POST /voice/process
// ======================= */
// router.post("/process", async (req, res) => {
//   const twiml = new VoiceResponse();
//   const { CallSid, Digits, SpeechResult } = req.body;

//   /* â”€â”€â”€ guard: session must exist â”€â”€â”€ */
//   const call = await CallSession.findOne({ callSid: CallSid });
//   if (!call) {
//     twiml.say("Technical error.");
//     twiml.hangup();
//     return res.type("text/xml").send(twiml.toString());
//   }

//   /* â”€â”€â”€ guard: nothing received â†’ replay last question â”€â”€â”€ */
//   if (!SpeechResult && !Digits) {
//     ask(twiml, call.temp.lastQuestion || "Kripya apna jawab bolein.", call);
//     await call.save();
//     return res.type("text/xml").send(twiml.toString());
//   }

//   /* =======================
//      IVR MENU  (DTMF only)
//   ======================= */
//   if (call.step === "ivr_menu") {
//     if (Digits === "2") {
//       twiml.say("Aapko agent se connect kiya ja raha hai.");
//       twiml.dial(process.env.HUMAN_AGENT_NUMBER);
//       return res.type("text/xml").send(twiml.toString());
//     }

//     if (Digits === "1") {
//       call.step = "ask_identifier";
//       ask(
//         twiml,
//         "Welcome to Rajesh JCB motors. Kripya apni machine ka chassis number ya registered mobile number boliye.",
//         call
//       );
//       await call.save();
//       return res.type("text/xml").send(twiml.toString());
//     }

//     // invalid key or no input
//     ask(twiml, "Kripya ek ya do dabayein.", call);
//     await call.save();
//     return res.type("text/xml").send(twiml.toString());
//   }

//   /* =======================
//      SPEECH PRE-PROCESSING
//      normalizeHindiIntent runs here once so that EVERY downstream match â€”
//      category detection AND sub-complaint keyword matching â€” already has
//      the romanized English equivalents appended.
//   ======================= */
//   const rawSpeech = normalizeText(cleanSpeech(SpeechResult || ""));
//   const speech = normalizeHindiIntent(rawSpeech);

//   console.log("ðŸŽ¤ RAW SPEECH :", SpeechResult);
//   console.log("ðŸ§¹ CLEANED    :", rawSpeech);
//   console.log("ðŸ”¤ NORMALIZED :", speech);

//   /* â”€â”€â”€ caller is confused / asking to repeat â”€â”€â”€ */
//   if (speech.length > 0 && isConfusedSpeech(speech)) {
//     ask(twiml, call.temp.lastQuestion || "Kripya dobara bolein.", call);
//     await call.save();
//     return res.type("text/xml").send(twiml.toString());
//   }

//   /* â”€â”€â”€ completely empty after cleaning â”€â”€â”€ */
//   if (!speech) {
//     call.temp.retries = (call.temp.retries || 0) + 1;

//     if (call.temp.retries >= 3) {
//       twiml.say(
//         "Humein aawaz sunai nahi de rahi. Aapko agent se connect kiya ja raha hai."
//       );
//       twiml.dial(process.env.HUMAN_AGENT_NUMBER);
//       return res.type("text/xml").send(twiml.toString());
//     }

//     ask(twiml, call.temp.lastQuestion || "Kripya apna jawab bolein.", call);
//     await call.save();
//     return res.type("text/xml").send(twiml.toString());
//   }

//   /* =======================
//      STATE MACHINE
//   ======================= */
//   switch (call.step) {
//     /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ IDENTIFIER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
//     case "ask_identifier": {
//       let digits = speech.replace(/\D/g, "");

//       // if digit extraction was too short try converting spoken Hindi words
//       if (digits.length < 10) {
//         const wordDigits = wordsToDigits(speech);
//         if (wordDigits.length >= 10) {
//           digits = wordDigits;
//         }
//       }

//       let customer = null;

//       // chassis: strip spaces + upper-case; override with word-digits if long enough
//       let chassis = speech.replace(/\s+/g, "").toUpperCase();
//       const digitFromWords = wordsToDigits(speech);
//       if (digitFromWords.length >= 4) {
//         chassis = digitFromWords;
//       }

//       // 1ï¸âƒ£  phone lookup
//       if (digits.length === 10) {
//         customer = await Customer.findOne({ phone: digits });
//       }
//       // 2ï¸âƒ£  chassis lookup
//       if (!customer) {
//         customer = await Customer.findOne({ chassisNo: chassis });
//       }

//       if (!customer) {
//         call.temp.retries = (call.temp.retries || 0) + 1;

//         if (call.temp.retries >= 3) {
//           twiml.say(
//             { voice: "Polly.Aditi", language: "hi-IN" },
//             "Humein details verify nahi ho pa rahi. Aapko agent se connect kiya ja raha hai."
//           );
//           twiml.dial(process.env.HUMAN_AGENT_NUMBER);
//           return res.type("text/xml").send(twiml.toString());
//         }

//         ask(
//           twiml,
//           "Record nahi mila. Kripya chassis number ya registered mobile number dobara boliye.",
//           call
//         );
//         break;
//       }

//       // âœ… customer found
//       call.temp.customerId = customer._id.toString();
//       call.temp.retries = 0;
//       call.step = "ask_machine_location";

//       ask(
//         twiml,
//         `Aapka record mil gaya. Aap ${customer.city} se ${customer.name} bol rahe hain. Machine kis location par hai?`,
//         call
//       );
//       break;
//     }

//     /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ LOCATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
//     case "ask_machine_location": {
//       if (speech.length < 3) {
//         ask(twiml, "Kripya poora location batayein.", call);
//         break;
//       }
//       call.temp.machineLocation = speech;
//       call.step = "ask_contact_name";
//       ask(twiml, "Contact person ka naam batayein.", call);
//       break;
//     }

//     /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CONTACT NAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
//     case "ask_contact_name": {
//       call.temp.contactName = speech;
//       call.step = "ask_complaint";
//       call.temp.retries = 0;
//       ask(twiml, "Machine ki complaint batayein.", call);
//       break;
//     }

//     /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ COMPLAINT DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
//     case "ask_complaint": {
//       call.temp.rawComplaint = rawSpeech; // always preserve original spoken text

//       const intent = detectComplaintIntent(speech);

//       if (!intent) {
//         call.temp.retries = (call.temp.retries || 0) + 1;

//         if (call.temp.retries >= 2) {
//           call.temp.retries = 0;
//           ask(
//             twiml,
//             "Kripya bolein: engine, tyre, AC, hydraulic ya electrical.",
//             call
//           );
//           break;
//         }

//         ask(
//           twiml,
//           "Kripya engine, hydraulic, AC, electrical ya tyre ka problem batayein.",
//           call
//         );
//         break;
//       }

//       // âœ… intent detected â€” store as flat fields (Mongoose-safe)
//       call.temp.retries = 0;
//       call.temp.detectedIntentPrimary = intent.primary;
//       call.temp.detectedIntentConfidence = intent.confidence;

//       /*
//        * BRANCHING:
//        *   HIGH confidence (0.95) â†’ single unambiguous match
//        *     â†’ set title, go straight to sub-complaint question
//        *   LOW  confidence (0.60) â†’ multiple categories matched
//        *     â†’ confirm category with caller first
//        */
//       if (intent.confidence >= 0.9) {
//         call.temp.complaintTitle = intent.primary;

//         if (followUpQuestions[intent.primary]) {
//           call.step = "ask_sub_complaint";
//           call.temp.subRetries = 0;
//           ask(twiml, followUpQuestions[intent.primary].question, call);
//         } else {
//           // no sub-questions defined â†’ save directly
//           call.temp.complaintSubTitle = "Other";
//           call.step = "save_complaint";
//         }
//       } else {
//         // ambiguous â†’ confirm with caller
//         call.step = "confirm_complaint";
//         ask(
//           twiml,
//           `Aap keh rahe hain ${intent.primary} ka issue hai, sahi? Haan ya nahi bolein.`,
//           call
//         );
//       }
//       break;
//     }

//     /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CONFIRM COMPLAINT (only when confidence is low) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
//     case "confirm_complaint": {
//       const isYes =
//         speech.includes("haan") ||
//         speech.includes("à¤¹à¤¾à¤‚") ||
//         speech.includes("yes") ||
//         speech.includes("ji") ||
//         speech.includes("sahi");

//       const isNo =
//         speech.includes("nahi") ||
//         speech.includes("à¤¨à¤¹à¥€à¤‚") ||
//         speech.includes("no");

//       if (isYes) {
//         const title = call.temp.detectedIntentPrimary;
//         call.temp.complaintTitle = title;

//         if (followUpQuestions[title]) {
//           call.step = "ask_sub_complaint";
//           call.temp.subRetries = 0;
//           ask(twiml, followUpQuestions[title].question, call);
//         } else {
//           call.temp.complaintSubTitle = "Other";
//           call.step = "save_complaint";
//         }
//         break;
//       }

//       if (isNo) {
//         call.step = "ask_complaint";
//         call.temp.retries = 0;
//         ask(twiml, "Theek hai, kripya complaint dobara batayein.", call);
//         break;
//       }

//       // neither yes nor no understood
//       ask(twiml, "Kripya haan ya nahi bolein.", call);
//       break;
//     }

//     /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SUB-COMPLAINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
//     case "ask_sub_complaint": {
//       const title = call.temp.complaintTitle;
//       const followUp = followUpQuestions[title];

//       // safety net: no config found â†’ default to Other
//       if (!followUp) {
//         call.temp.complaintSubTitle = "Other";
//         call.step = "save_complaint";
//         break;
//       }

//       call.temp.subRetries = call.temp.subRetries || 0;

//       // match against NORMALIZED speech â€” Devanagariâ†’romanized already done
//       let detectedSub = null;
//       for (const [keyword, subTitle] of Object.entries(followUp.options)) {
//         if (speech.includes(keyword)) {
//           detectedSub = subTitle;
//           break;
//         }
//       }

//       if (!detectedSub) {
//         call.temp.subRetries += 1;

//         // after 2 failed attempts â†’ default to Other and save
//         if (call.temp.subRetries >= 2) {
//           call.temp.complaintSubTitle = "Other";
//           call.step = "save_complaint";
//           break;
//         }

//         // retry with a clearer prompt
//         ask(
//           twiml,
//           followUp.question + " Kripya thoda clear bolein.",
//           call
//         );
//         break;
//       }

//       // âœ… sub-complaint matched
//       call.temp.subRetries = 0;
//       call.temp.complaintSubTitle = detectedSub;
//       call.step = "save_complaint";
//       break;
//     }

//     /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SAVE & CLOSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
//     case "save_complaint": {
//       const customer = await Customer.findById(call.temp.customerId);

//       if (!customer) {
//         // edge-case: customer removed between steps
//         twiml.say("Technical error. Aapko agent se connect kiya ja raha hai.");
//         twiml.dial(process.env.HUMAN_AGENT_NUMBER);
//         return res.type("text/xml").send(twiml.toString());
//       }

//       await Complaint.create({
//         customerId: customer._id,
//         chassisNo: customer.chassisNo || "Unknown",
//         phone: customer.phone,
//         customerName: customer.name || "Unknown",
//         contactPersonName: call.temp.contactName || "Unknown",
//         machineLocation: call.temp.machineLocation || "Unknown",
//         description_raw: call.temp.rawComplaint || "Not provided by caller",
//         complaintTitle: call.temp.complaintTitle || "NA",
//         complaintSubTitle: call.temp.complaintSubTitle || "Other",
//         callSid: CallSid,
//         source: "IVR_VOICE_BOT",
//       });

//       call.step = "done";
//       twiml.say(
//         { voice: "Polly.Aditi", language: "hi-IN" },
//         "Dhanyavaad. Aapki complaint register ho gayi hai. Hamara team aapke saath jaldi contact karega."
//       );
//       twiml.hangup();
//       break;
//     }
//   }

//   await call.save();
//   res.type("text/xml").send(twiml.toString());
// });

// export default router;